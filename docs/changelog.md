/**
 * @file: changelog.md
 * @description: Хронологический журнал изменений проекта.
 * @dependencies: docs/Project.md, docs/Tasktracker.md
 * @created: 2025-09-13
 */

## [2025-09-13] - Инициализация документации проекта
### Добавлено
- Папка `docs/` и файлы: `Project.md`, `Tasktracker.md`, `Diary.md`, `qa.md`, `changelog.md`
- Файл правил `/.cursorrules`

### Изменено
- Заполнен `Project.md` детальным описанием архитектуры, API и НФТ
- Заполнен `Tasktracker.md` задачами, приоритетами и зависимостями

### Исправлено
- —

## [2025-09-13] - Введение config/markers.json и якорное позиционирование
### Добавлено
- Файл `config/markers.json` с начальными координатами якорей и параметрами шрифта

### Изменено
- `server.js`: чтение конфигурации маркеров, кэширование шаблона `pattern1.pdf`, отрисовка значений по якорям

### Исправлено
- Исключены жёстко заданные координаты внутри кода; теперь координаты централизованы в конфиге

## [2025-09-13] - Исправление генерации PDF и поддержка .env
### Добавлено
- Поддержка `.env` для конфигурации PORT (по умолчанию 3000)
- Установлен `fontkit` для будущей поддержки кастомных шрифтов
- Скачан `DejaVuSans.ttf` в `assets/fonts/`

### Изменено
- `server.js`: добавлена поддержка `FONT_PATH`, кэширование шаблона PDF, якорное позиционирование
- `README.md`: инструкции по настройке `.env` и шрифтов
- Тесты обновлены для использования переменной PORT

### Исправлено
- Генерация PDF теперь работает с латинскими символами
- Кириллица корректно отклоняется с ошибкой `FONT_UNSUPPORTED`
- Синхронизированы порты в сервере, тестах и документации

## [2025-09-13] - Полная поддержка кириллицы в PDF
### Добавлено
- Правильная интеграция `@pdf-lib/fontkit` для поддержки кастомных шрифтов
- Скачан корректный `DejaVuSans.ttf` (757KB) из CDN jsdelivr

### Изменено
- Заменен пакет `fontkit` на `@pdf-lib/fontkit` для совместимости с pdf-lib
- `server.js`: регистрация fontkit для каждого PDF документа
- Убрано предупреждение о недоступности кириллицы из интерфейса

### Исправлено
- PDF успешно генерируется с кириллическими символами
- Автоматическое переключение между стандартными и кастомными шрифтами

## [2025-09-14] - Обслуживание Git и безопасный скрипт сохранения
### Добавлено
- Скрипт `scripts/git_save_safe.sh` для безопасного добавления, коммита и пуша без pager

### Изменено
- Локальная конфигурация git: отключение pager для `status`, `log`, `diff`, `branch`
- Приведены в порядок вспомогательные git-скрипты (устранение побочных эффектов имен файлов)

### Исправлено
- Удалены мусорные файлы, появлявшиеся из-за некорректных аргументов команд (`how --oneline -s HEAD`, `tatus`, и др.)

## [2025-09-14] - Смена главной ветки на main
### Добавлено
- Обновлена документация о ветках; указано, что основная ветка — `main`

### Изменено
- Переименована ветка `feature/hybrid-pdf-architecture` → `main`
- Удалена удалённая ветка `feature/hybrid-pdf-architecture`, `main` назначена веткой по умолчанию на GitHub

### Исправлено
- Консолидация истории изменений в `main` для единообразия

## [2025-01-13] - Гибридная архитектура для пользовательских шаблонов
### Добавлено
- Структура `backend/` с модульной архитектурой (api, services, utils, models)
- Схема манифеста `Manifest.js` для кэширования координат меток
- API эндпоинты: POST `/api/templates`, GET `/api/templates/:id/manifest`, POST `/api/generate`
- Авто-детекция текстовых меток с помощью `pdfjs-dist`
- Поддержка AcroForm полей в шаблонах
- Зависимости: `cors`, `multer`, `pdfjs-dist`
- Обработка дубликатов меток `msr:` через привязки по порядку

### Изменено
- `package.json`: добавлены новые зависимости для гибридного подхода
- Архитектура: переход от статичных координат к динамическому детекту меток

### Исправлено
- Поддержка пользовательских шаблонов без предварительной настройки координат

## [2025-01-13] - Консолидация серверов и модуль расчётов
### Добавлено
- Модуль расчётов `backend/src/services/calculationsService.js` с функциями:
  - `calculateWaterConsumption()` - основные расчёты водопотребления
  - `formatNumber()` - форматирование чисел для PDF
  - `validateCalculationData()` - валидация входных данных
  - `getCalculationConfig()` - конфигурация из переменных окружения
- Юнит-тесты `calculationsService.test.js` с полным покрытием
- API эндпоинт `POST /api/calculate` для выполнения расчётов
- Интеграция расчётов в `templateService.js` для автоматического заполнения PDF

### Изменено
- `templateService.js`: интеграция модуля расчётов в функцию `generatePDF()`
- `routes.js`: добавлен эндпоинт для расчётов
- `package.json`: обновлена точка входа на `backend/app.js`
- Удален дублирующий `server.js` (старый монолитный сервер)

### Исправлено
- Устранено дублирование функциональности между двумя серверами
- Централизованы расчёты в отдельном сервисе
- Улучшена модульность и поддерживаемость кода

## [2025-01-13] - Исправление генерации PDF и полное тестирование
### Добавлено
- Полное тестирование API эндпоинтов: `/api/calculate`, `/api/templates`, `/api/generate`
- Интеграционный тест полного цикла работы с PDF

### Изменено
- `public/script.js`: исправлена передача данных `dailyConsumption` для расчётов
- `backend/src/api/routes.js`: добавлена правильная обработка данных для расчётов
- `backend/src/services/templateService.js`: разделение данных для расчётов и заполнения PDF

### Исправлено
- Генерация PDF теперь работает корректно с автоматическими расчётами
- Правильная передача `dailyConsumption` в модуль расчётов
- Полный цикл: загрузка шаблона → заполнение данных → генерация PDF → скачивание

## [2025-01-13] - Добавление пользовательского маппинга полей к меткам
### Добавлено
- Поля ввода для имен меток справа от каждого поля формы в веб-интерфейсе
- Поддержка пользовательского маппинга полей к именам меток в PDF
- API поддержка `fieldMappings` в эндпоинте `/api/generate`
- Стили для новых полей ввода меток с визуальным разделением

### Изменено
- `public/index.html`: добавлены поля ввода для имен меток с placeholder значениями
- `public/styles.css`: стили для `.input-with-marker` и `.marker-input`
- `public/script.js`: сбор данных о маппинге полей и передача в API
- `backend/src/api/routes.js`: обработка `fieldMappings` в запросе генерации PDF
- `backend/src/services/templateService.js`: использование пользовательского маппинга при заполнении PDF

### Исправлено
- Пользователи теперь могут настраивать имена меток для каждого поля
- Гибкость в работе с различными PDF шаблонами без изменения кода

## [2025-01-13] - Добавление полей ввода меток в блок результатов
### Добавлено
- Поля ввода для имен меток в блоке результатов расчётов
- Стили для `.result-item` с визуальным разделением результатов и полей меток
- Поддержка маппинга полей из блока результатов в API

### Изменено
- `public/index.html`: добавлены поля ввода меток для часового и секундного расхода
- `public/styles.css`: стили для блока результатов с полями меток
- `public/script.js`: сбор данных о маппинге из блока результатов
- `backend/src/services/templateService.js`: обработка маппинга полей из результатов

### Исправлено
- Полная настройка имен меток для всех полей, включая расчётные значения
- Улучшенный пользовательский интерфейс с возможностью настройки всех меток

## [2025-01-13] - Исправление правил подстановки значений в PDF
### Добавлено
- Четкие правила подстановки значений: исходные данные как есть, вычисленные - только цифры

### Изменено
- `backend/src/services/templateService.js`: исправлена логика маппинга значений
- Убраны единицы измерения из подставляемых в PDF значений

### Исправлено
- Исходные данные (текст, числа) подставляются точно как введены пользователем
- Вычисленные значения подставляются только в виде цифр без единиц измерения
- Устранена путаница с единицами измерения в PDF шаблоне

